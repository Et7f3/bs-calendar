##############################################################################
#                                                                            #
#                       Basic Makefile using ocamldefun           	     #
#                                                                            #
#                      Copyright (C) 2002 Julien SIGNOLES                    #
#                                                                            #
#       $Id: Makefile.in,v 1.5 2003-07-05 06:39:31 signoles Exp $            #
#                                                                            #
##############################################################################

# Used programs
###############

CAMLC	= @OCAMLC@
CAMLOPT	= @OCAMLOPT@
CAMLDEP	= @OCAMLDEP@
CAMLWEB	= @OCAMLWEB@
CAMLWC	= @OCAMLWC@
CAMLDOT	= @OCAMLDOT@
CAMLLIB	= @OCAMLLIB@

# Project
#########

NAME	= calendar
DIRS	= src/$(NAME).cma src/$(NAME).cmxa

SRC	= time_Zone.mli time_Zone.ml period.mli \
	time.mli time.ml date.mli date.ml calendar.mli calendar.ml
SRC	:= $(addprefix src/, $(SRC))

ML	= $(filter %.ml, $(SRC))
MLI	= $(filter %.mli, $(SRC))

CMO	= $(ML:.ml=.cmo)
CMX	= $(CMO:.cmo=.cmx)

# Libs and flags
################

CAMLIBS	= -I $(DIRS)

CAMLFLAGS= $(CAMLIBS)
BYTEFLAGS= $(CAMLFLAGS)
OPTFLAGS = $(CAMLFLAGS) -noassert -I src/others

# Main rules
############

all: $(LIBS)

src/$(NAME).cma: $(CMO)
	$(CAMLC) $(BYTEFLAGS) -a -o $@ unix.cma str.cma $^

src/$(NAME).cmxa: src/others/unix.cmx src/others/str.cmx $(CMX)
	$(CAMLOPT) $(OPTFLAGS) -a -o $@ \
		-cclib -lunix -cclib -lstr -cclib -L$(CAMLLIB) $^

# Generic rules
###############

.SUFFIXES: .ml .mli .cmo .cmi .cmx

.mli.cmi:
	$(CAMLC) $(BYTEFLAGS) -c $<

.ml.cmo:
	$(CAMLC) $(BYTEFLAGS) -c $<

.ml.o:
	$(CAMLOPT) $(OPTFLAGS) -c $<

.ml.cmx:
	$(CAMLOPT) $(OPTFLAGS) -c $<

# Tests
#######

tests/%: src/$(NAME).cma tests/%.cmo
	$(CAMLC) -o $@ -I src $^

tests: tests/test_timezone tests/test_date tests/test_time tests/test_calendar

# Documentation
###############

wc: $(SRC)
	$(CAMLWC) -p $^

$(NAME).ps.gz: $(SRC)
	$(CAMLWEB) --ps -o $(basename $@) $^
	gzip -f --best $(basename $@)

# Install
#########

install:
	cp -f $(LIBS) $(CAMLLIB)

uninstall:
	rm -f $(patsubst src/, $(CAMLLIB), $(LIBS))

# Exporting
###########

# Rebuilding Makefile
#####################

Makefile: Makefile.in config.status
	./config.status			

config.status: configure
	./config.status --recheck

configure: configure.in
	autoconf

# Emacs tags
############

TAGS: $(SRC)
	otags -o $@ $^

# Cleaning
##########

clean:
	rm -f TAGS $(NAME).ps.gz
	rm -f tests/test_timezone tests/test_date tests/test_time tests/test_calendar
	for i in . src src/others tests; do \
	  rm -f $$i/*~ $$i/\#* $$i/*.cm[iox] $$i/*.*a $$i/*.o $$i/a.out; \
	done

# Depend
########

depend:
	rm -f .depend
	for i in src src/others; do \
	  $(CAMLDEP) $(CAMLIBS) $$i/*.ml $$i/*.mli; \
	done > .depend

include .depend
