#  Calendar library
#  Copyright (C) 2003 Julien SIGNOLES
#  
#  This library is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Library General Public
#  License version 2, as published by the Free Sofware Foundation.
#  
#  This library is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#  
#  See the GNU Library General Public License version 2 for more details

# Used programs
###############

CAMLC	= @OCAMLC@
CAMLOPT	= @OCAMLOPT@
CAMLDEP	= @OCAMLDEP@
CAMLWEB	= @OCAMLWEB@
CAMLWC	= @OCAMLWC@
CAMLDOT	= @OCAMLDOT@
CAMLLIB	= @OCAMLLIB@
CAML2HTML= caml2html

# Project
#########

NAME	= calendar

LIBS	= src/$(NAME).cma src/$(NAME).cmxa

DIRS	= src

SRC	= time_Zone.mli time_Zone.ml period.mli \
	time.mli time.ml date.mli date.ml calendar.mli calendar.ml
SRC	:= $(addprefix src/, $(SRC))

ML	= $(filter %.ml, $(SRC))
MLI	= $(filter %.mli, $(SRC))

CMO	= $(ML:.ml=.cmo)
CMX	= $(CMO:.cmo=.cmx)
CMI	= $(MLI:.mli=.cmi) # ok with those source files

# Libs and flags
################

CAMLIBS	= -I $(DIRS)

CAMLFLAGS= $(CAMLIBS)
BYTEFLAGS= $(CAMLFLAGS)
OPTFLAGS = $(CAMLFLAGS) -noassert -I src/others

# Main rules
############

all: $(LIBS)

src/$(NAME).cma: $(CMO)
	$(CAMLC) $(BYTEFLAGS) -a -o $@ unix.cma str.cma $^

src/$(NAME).cmxa: src/others/unix.cmx src/others/str.cmx $(CMX)
	$(CAMLOPT) $(OPTFLAGS) -a -o $@ \
		-cclib -lunix -cclib -lstr -cclib -L$(CAMLLIB) $^

html/touch-html:
	mkdir html
	touch $@

mli2html: $(patsubst src/%.mli, html/%.html, $(filter %.mli, $(SRC)))

# Generic rules
###############

%.gz: %
	gzip -f --best $<

.SUFFIXES: .ml .mli .cmo .cmi .cmx .html

html/%.html: src/%.mli html/touch-html
	$(CAML2HTML) -o $@ $<

.mli.cmi:
	$(CAMLC) $(BYTEFLAGS) -c $<

.ml.cmo:
	$(CAMLC) $(BYTEFLAGS) -c $<

.ml.o:
	$(CAMLOPT) $(OPTFLAGS) -c $<

.ml.cmx:
	$(CAMLOPT) $(OPTFLAGS) -c $<

# Tests
#######

TESTS	= test_timezone test_time test_date test_calendar
TESTS	:= $(addprefix tests/, $(TESTS))

TESTS_CMO= $(addsuffix .cmo, $(TESTS))

$(TESTS_CMO): tests/gen_test.cmo
tests/test.cmo: $(TESTS_CMO)

tests/test: src/$(NAME).cma tests/test.cmo
	$(CAMLC) -o $@ $(BYTEFLAGS) src/$(NAME).cma tests/gen_test.cmo \
		$(TESTS_CMO) tests/test.cmo

.PHONY: tests
tests: BYTEFLAGS := $(BYTEFLAGS) -I tests
tests: tests/test
	./$<

# Documentation
###############

wc: $(SRC)
	$(CAMLWC) -p $^

$(NAME).ps: $(SRC)
	$(CAMLWEB) --ps -o $@ $^

# Install
#########

install:
	cp -f $(LIBS) $(CMI) $(CMO) $(CMX) $(CAMLLIB)

uninstall:
	rm -f $(addprefix $(CAMLLIB)/, $(notdir $(LIBS) $(CMI) $(CMO) $(CMX)))

# Exporting
###########

EXPORT_DIR= $$HOME/WWW/prog/calendar

export: $(NAME).ps.gz mli2html
	cvs export -d /tmp/$(NAME) -D now $(NAME)
	cp -rf .depend configure $(NAME).ps.gz html /tmp/$(NAME)
	cp -f $(NAME).ps.gz html/*.html $(EXPORT_DIR)
	rm -f /tmp/$(NAME)/html/touch-html
	cd /tmp; \
	  (tar cvf $(NAME).tar $(NAME); \
	   gzip -f --best $(NAME).tar; \
	   rm -rf $(NAME); \
	   mv $(NAME).tar.gz $(EXPORT_DIR))


# Rebuilding Makefile
#####################

Makefile: Makefile.in config.status
	./config.status			

config.status: configure
	./config.status --recheck

configure: configure.in
	autoconf

# Emacs tags
############

TAGS: $(SRC)
	otags -o $@ $^

# Cleaning
##########

clean:
	rm -f TAGS $(NAME).ps.gz $(TESTS)
	for i in . src src/others tests; do \
	  rm -f $$i/*~ $$i/\#* $$i/*.cm[iox] $$i/*.*a $$i/*.o $$i/a.out; \
	done

dist-clean: clean
	rm -rf $(NAME).ps.gz html

clean-configure: dist-clean
	rm -f Makefile configure config.*

# Depend
########

depend:
	rm -f .depend
	for i in src src/others tests; do \
	  $(CAMLDEP) $(CAMLIBS) $$i/*.ml $$i/*.mli; \
	done > .depend

include .depend
